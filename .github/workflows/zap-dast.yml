name: ZAP DAST (Baseline)

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  zap-baseline:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Compose
        run: docker compose version

      - name: Build & start stack
        run: |
          docker compose down -v
          docker compose up --build -d
          docker compose ps

      - name: Wait for backend (http://localhost:8080/actuator/health)
        run: |
          for i in {1..60}; do
            if curl -fsS http://localhost:8080/actuator/health >/dev/null; then
              echo "Backend is up"
              exit 0
            fi
            echo "Waiting for backend..."
            sleep 2
          done
          echo "Backend did not become ready in time"; exit 1

      - name: Wait for frontend (http://localhost:5173)
        run: |
          for i in {1..60}; do
            if curl -fsS http://localhost:5173 >/dev/null; then
              echo "Frontend is up"
              exit 0
            fi
            echo "Waiting for frontend..."
            sleep 2
          done
          echo "Frontend did not become ready in time"; exit 1

      # ---------- Frontend ZAP Baseline ----------
      - name: ZAP Baseline Scan (Frontend)
        uses: zaproxy/action-baseline@v0.13.0
        with:
          target: 'http://localhost:5173'
          docker_name: 'ghcr.io/zaproxy/zaproxy:stable'
          rules_file_name: ''          # optional: add a zap_rules.conf if you want to ignore items
          cmd_options: >-
            -m 3
            -a
            -T 5
          allow_issue_writing: false
          fail_action: false           # keep CI green for now; set to true to fail on WARN/FAIL

      - name: Collect ZAP Frontend Reports
        if: always()
        run: |
          mkdir -p zap-reports
          # The action writes into the repo workspace by default:
          # report_html.html, report_md.md, report_json.json
          mv report_html.html zap-reports/zap-frontend.html || true
          mv report_md.md     zap-reports/zap-frontend.md   || true
          mv report_json.json zap-reports/zap-frontend.json || true

      # ---------- Backend ZAP Baseline ----------
      - name: ZAP Baseline Scan (Backend/API)
        uses: zaproxy/action-baseline@v0.13.0
        with:
          target: 'http://localhost:8080'
          docker_name: 'ghcr.io/zaproxy/zaproxy:stable'
          rules_file_name: ''
          cmd_options: >-
            -m 3
            -a
            -T 5
          allow_issue_writing: false
          fail_action: false

      - name: Collect ZAP Backend Reports
        if: always()
        run: |
          # subsequent baseline run overwrites the same filenames; move them again
          mv report_html.html zap-reports/zap-backend.html || true
          mv report_md.md     zap-reports/zap-backend.md   || true
          mv report_json.json zap-reports/zap-backend.json || true

      - name: Upload ZAP reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-dast-reports
          path: zap-reports

      - name: Tear down stack
        if: always()
        run: docker compose down -v
