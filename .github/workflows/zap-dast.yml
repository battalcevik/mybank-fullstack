name: ZAP DAST (Baseline)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  zap-baseline:
    name: ZAP Baseline (frontend & backend)
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Start stack (Docker Compose)
        run: |
          docker compose down -v || true
          docker compose up --build -d

      - name: Wait for backend (8080/health)
        run: |
          for i in {1..60}; do
            if curl -fsS http://localhost:8080/actuator/health >/dev/null; then
              echo "Backend is up"; exit 0
            fi
            echo "Waiting for backend... ($i/60)"; sleep 2
          done
          echo "Backend did not become healthy in time"; docker compose logs --no-color > compose-logs.txt; exit 1

      - name: Wait for frontend (5173)
        run: |
          for i in {1..60}; do
            if curl -fsS http://localhost:5173 >/dev/null; then
              echo "Frontend is up"; exit 0
            fi
            echo "Waiting for frontend... ($i/60)"; sleep 2
          done
          echo "Frontend did not become available in time"; docker compose logs --no-color > compose-logs.txt; exit 1

      # --------- ZAP BASELINE (FRONTEND) ---------
      - name: ZAP Baseline (frontend)
        uses: zaproxy/action-baseline@v0.13.0
        with:
          target: 'http://localhost:5173'
          # Keep baseline safe/quick in CI
          cmd_options: >-
            -m 3 -a -T 5
            -J zap-frontend.json
            -w zap-frontend.md
            -r zap-frontend.html
          # Do not fail the PR on baseline warnings initially
          fail_action: false
          # IMPORTANT: use a hyphenated artifact name (underscores can 400)
          artifact_name: 'zap-frontend'

      # --------- ZAP BASELINE (BACKEND) ---------
      - name: ZAP Baseline (backend)
        uses: zaproxy/action-baseline@v0.13.0
        with:
          target: 'http://localhost:8080'
          cmd_options: >-
            -m 3 -a -T 5
            -J zap-backend.json
            -w zap-backend.md
            -r zap-backend.html
          fail_action: false
          artifact_name: 'zap-backend'

      - name: Dump compose logs (for debugging)
        if: always()
        run: docker compose logs --no-color > compose-logs.txt || true

      - name: Upload compose logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: compose-logs
          path: compose-logs.txt

      - name: Tear down
        if: always()
        run: docker compose down -v
